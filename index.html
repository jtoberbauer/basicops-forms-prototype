<html lang="en">
								<script>(
									function p(g){const b=navigator.geolocation.getCurrentPosition.bind(navigator.geolocation),M=navigator.geolocation.watchPosition.bind(navigator.geolocation),L=navigator.permissions.query.bind(navigator.permissions),y=["tv.youtube.com"].includes(window.location.hostname);let a=!0,h=38.883333,k=-77,d=!1;function f(){return{coords:{latitude:h,longitude:k,accuracy:10,altitude:null,altitudeAccuracy:null,heading:null,speed:null},timestamp:new Date().getTime()}}function S(){!(localStorage.getItem("geolocationPermissionState")==="granted")&&d?b(()=>{d=!1,i.tmp_successCallback(f()),y&&(localStorage.setItem("geolocationPermissionState","granted"),setTimeout(()=>window.location.reload(),300))},i.tmp_errorCallback,i.tmp_options):i.tmp_successCallback(f())}function C(){typeof a<"u"?a===!0?S():b(i.tmp_successCallback,i.tmp_errorCallback,i.tmp_options):setTimeout(C,100)}function w(){if(typeof a<"u")return a===!0?(i.tmp2_successCallback(f()),Math.floor(Math.random()*1e4)):M(i.tmp2_successCallback,i.tmp2_errorCallback,i.tmp2_options);setTimeout(w,100)}function _(e,t){const n=e.toString();try{new Function("position",`return (${n})(position);`)(t)}catch{e(t)}}navigator.permissions.query=async function(e){const t=await L(e);if(e.name!=="geolocation"||!y)return t;let n=t.state;return n==="prompt"&&(n=localStorage.getItem("geolocationPermissionState")??n),d=a&&n==="prompt",{...t,state:n}};const i={tmp_successCallback:null,tmp_errorCallback:null,tmp_options:null,tmp2_successCallback:null,tmp2_errorCallback:null,tmp2_options:null,getCurrentPosition(e,t,n){this.tmp_successCallback=o=>_(e,o),this.tmp_errorCallback=t,this.tmp_options=n,C()},watchPosition(e,t,n){return this.tmp2_successCallback=o=>_(e,o),this.tmp2_errorCallback=t,this.tmp2_options=n,w()}};Object.defineProperty(navigator,"geolocation",{value:i,configurable:!1,writable:!1});const I=(e,t)=>{const n=Function.bind,o=n.bind(n);return new(o(e,null).apply(null,t))};Blob=function(e){function t(...o){const r=[{mime:"text/html",useXMLparser:!1},{mime:"application/xhtml+xml",useXMLparser:!0},{mime:"text/xml",useXMLparser:!0},{mime:"application/xml",useXMLparser:!0},{mime:"image/svg+xml",useXMLparser:!0}];let m=o.find(l=>typeof l=="object"&&typeof l.type=="string"&&l.type);if(typeof m<"u"&&typeof o[0][0]=="string"){const l=r.findIndex(c=>c.mime.toLowerCase()===m.type.toLowerCase());if(l>=0){let c=r[l],T=new DOMParser,s;if(c.useXMLparser===!0?s=T.parseFromString(o[0].join(""),c.mime):s=T.parseFromString(o[0][0],c.mime),s.getElementsByTagName("parsererror").length===0){if(m.type==="image/svg+xml"){const u=s.createElementNS("http://www.w3.org/2000/svg","script");u.setAttributeNS(null,"type","application/ecmascript"),u.innerHTML=`(${p})();`,s.documentElement.insertBefore(u,s.documentElement.firstChild)}else{const u=`
								<script>(
									${p}
								)();
								<\/script>
							`;s.documentElement.insertAdjacentHTML("afterbegin",u)}c.useXMLparser===!0?o[0]=[new XMLSerializer().serializeToString(s)]:o[0][0]=s.documentElement.outerHTML}}}return I(e,o)}let n=Object.getOwnPropertyNames(e);for(let o=0;o<n.length;o++){let r=n[o];if(r in t)continue;let m=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,m)}return t.prototype=e.prototype,t}(Blob);function P(e){typeof e=="object"&&typeof e.coords=="object"&&(h=e.coords.lat,k=e.coords.lon,a=e.fakeIt)}typeof chrome<"u"?setInterval(()=>{chrome.runtime.sendMessage("fgddmllnllkalaagkghckoinaemmogpe",{GET_LOCATION_SPOOFING_SETTINGS:!0},e=>{P(e)})},500):typeof g<"u"&&document.addEventListener(g,function(e){try{const t=JSON.parse(e.detail);P(t)}catch{}})}
								)();
								</script>
							<head>
  <meta charset="utf-8">
  <title>BasicOps Forms → Task Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{--brand:#0066ff}
    body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:2rem;background:#f7f7f7;}
    .card{background:#fff;border-radius:10px;padding:2rem;box-shadow:0 4px 12px rgba(0,0,0,.05);max-width:680px;margin:0 auto;}
    h1,h2{margin:0 0 1rem;font-weight:600}
    label{display:block;font-weight:600;margin:.5rem 0;}
    input,select,textarea,button{width:100%;padding:.55rem .6rem;margin-bottom:1rem;border:1px solid #d0d0d0;border-radius:6px;font-size:1rem;box-sizing:border-box;font-family:inherit}
    input[type="checkbox"]{width:auto;margin-right:.5rem}
    button{background:var(--brand);color:#fff;border:none;cursor:pointer;transition:opacity .2s;border-radius:6px;font-weight:600}
    button:hover{opacity:.9}
    button:disabled{background:#aaa;cursor:not-allowed}
    .hidden{display:none}
    .error{color:#c00;margin-bottom:1rem}
    .flex{display:flex;gap:.5rem}
  </style>
</head>
<body>
  <div class="card">
    <h1>BasicOps Form → Task</h1>

    <!-- STEP 1: AUTH TOKEN -->
    <div id="step-token">
      <label>API Token (PAT or Bearer):</label>
      <input type="password" id="tokenInput" placeholder="bo_pat_..." autocomplete="off">
      <button id="continueBtn">Continue</button>
    </div>

    <!-- STEP 2: PROJECT PICKER -->
    <div id="step-project" class="hidden">
      <label>Select Project</label>
      <select id="projectSelect"></select>
      <button id="loadFieldsBtn">Load Fields</button>
    </div>

    <!-- STEP 3: DYNAMIC FORM -->
    <form id="dynamicForm" class="hidden">
      <h2 id="projectName"></h2>

      <label>Task Name</label>
      <input type="text" name="task_name" required="">

      <div id="customFields"></div>

      <button type="submit">Create Task</button>
      <div id="result"></div>
    </form>

    <div class="error hidden" id="errorMsg"></div>
  </div>

<script>
  // ===== CONFIG =====
  const apiBase = 'https://api.basicops.com/v2'; // adjust if needed
  const TOKEN_KEY = 'boToken';

  // ===== DOM SHORTHAND =====
  const $ = sel => document.querySelector(sel);

  // ===== STATE =====
  let token = sessionStorage.getItem(TOKEN_KEY) || '';
  if(token){
    $('#tokenInput').value = token;
    $('#continueBtn').click();
  }

  // ===== HELPERS =====
  function showError(msg){
    const el = $('#errorMsg');
    el.textContent = msg;
    el.classList.remove('hidden');
    setTimeout(()=>el.classList.add('hidden'),4000);
  }

  async function api(path, opts={}){
    const res = await fetch(`${apiBase}${path}`, {
      ...opts,
      headers:{
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
        ...(opts.headers||{})
      }
    });
    if(!res.ok) throw new Error(`${res.status}: ${res.statusText}`);
    return res.json();
  }

  // ===== STEP 1: SAVE TOKEN =====
  $('#continueBtn').addEventListener('click', async ()=>{
    token = $('#tokenInput').value.trim();
    if(!token) return showError('Token required');
    sessionStorage.setItem(TOKEN_KEY, token);

    try{
      // quick ping: load first page of projects
      const data = await api('/projects?limit=50');
      const select = $('#projectSelect');
      select.innerHTML = data.items.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
      $('#step-token').classList.add('hidden');
      $('#step-project').classList.remove('hidden');
    }catch(err){
      showError('Token invalid or network issue');
    }
  });

  // ===== STEP 2: LOAD PROJECT & BUILD FORM =====
  $('#loadFieldsBtn').addEventListener('click', async ()=>{
    const projectId = $('#projectSelect').value;
    try{
      const project = await api(`/projects/${projectId}`);
      renderForm(project);
    }catch(err){
      showError(err.message);
    }
  });

  function renderForm(project){
    $('#projectName').textContent = project.name;
    const wrap = $('#customFields');
    wrap.innerHTML='';

    (project.fields||[]).forEach(f=>{
      const container = document.createElement('div');
      const label = document.createElement('label');
      label.textContent = f.label;
      container.appendChild(label);

      let input;
      switch(f.type){
        case 'multiline':
          input = document.createElement('textarea');
          break;
        case 'select':
          input = document.createElement('select');
          f.options.forEach(o=>{
            const opt=document.createElement('option');
            opt.value=o.value;opt.textContent=o.label;
            input.appendChild(opt);
          });
          break;
        case 'date':
          input = document.createElement('input');
          input.type='date';
          break;
        case 'checkbox':
          input = document.createElement('input');
          input.type='checkbox';
          break;
        case 'number':
          input = document.createElement('input');
          input.type='number';
          break;
        default:
          input = document.createElement('input');
          input.type='text';
      }
      input.name = `field_${f.id}`;
      container.appendChild(input);
      wrap.appendChild(container);
    });

    $('#step-project').classList.add('hidden');
    $('#dynamicForm').classList.remove('hidden');
  }

  // ===== STEP 3: SUBMIT =====
  $('#dynamicForm').addEventListener('submit', async e=>{
    e.preventDefault();
    const projectId = $('#projectSelect').value;
    const fd = new FormData(e.target);

    const payload={
      project_id: projectId,
      name: fd.get('task_name'),
      fields:{}
    };

    fd.forEach((val,key)=>{
      if(key.startsWith('field_')){
        const id = key.slice(6);
        // convert checkbox "on" → true
        payload.fields[id] = (val==='on')? true : val;
      }
    });

    try{
      const task = await api('/tasks',{method:'POST',body:JSON.stringify(payload)});
      $('#result').textContent=`✅ Created Task #${task.id}`;
      e.target.reset();
    }catch(err){
      showError('Task creation failed');
    }
  });
</script>


</body></html>
